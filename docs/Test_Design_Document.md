# テスト設計書
[test作業中のbranchはコチラ](https://github.com/ms-engineer-bc25-04/sec9_teamB/tree/feature/qa-test)

---

## 1. テスト設計の全体方針

- **目的**  
  本プロジェクトの品質を確保し、仕様通りの動作、信頼性および保守性を保証する。  
  バックエンドAPI（FastAPI）、フロントエンド（React/Next.js）、DB（PostgreSQL）を含むシステム全体の品質を担保する。

- **品質保証範囲**  
  - バックエンドAPIの機能・性能・セキュリティ  
  - フロントエンドUIの操作性・バリデーション・画面遷移  
  - DBのデータ整合性・シーディング  
  - システム全体の連携動作（結合テスト・E2Eテスト）  

- **テストレイヤー**  
  - **単体テスト（Unit Test）**  
    各関数、クラス、API単位での動作確認。主に **Vitest** と **React Testing Library** を使用。  
  - **結合テスト（Integration Test）**  
    APIとDB連携、複数コンポーネント間連携を検証。Mockやテスト用DB（SQLite in-memoryなど）を活用。  
  - **E2Eテスト（End-to-End Test）**  
    実際のユーザー操作を模擬し、画面遷移やAPI連携を含むシステム全体の動作確認。  
    （現状はCypress等の採用を検討中）

- **保証する品質**  
  - 機能要件の充足  
  - 入力バリデーション・エラー処理  
  - セキュリティ（認証・認可、脆弱性対策）  
  - データ整合性・マイグレーションの安全性  
  - パフォーマンス（必要に応じて計測・改善）  

---

## 2. テスト環境

- **環境構成**  
  - ローカル開発環境：Docker Composeでbackend（FastAPI）、DB（PostgreSQL）、frontend（React/Next.js）を起動  
  - CI環境（GitHub Actions）：Vitest実行およびESLintチェックの自動化  
  - テスト用DB：SQLite in-memoryやPostgreSQLの専用テストデータベースを利用し、実DBへの影響を排除

- **依存性管理**  
  - 外部APIやDBアクセスはMock/Stubを利用  
  - DBマイグレーションはAlembicで管理し、マイグレーション前後の状態を検証  

- **静的解析**  
  - **ESLint** を利用し、コード品質を維持・向上  
  - CIでESLintチェックを自動実行し、警告・エラーの早期検出  

---

## 3. テスト方針

- **優先順位**  
  - クリティカルパスや頻度の高いユースケースを重点的にテスト  
  - 障害影響が大きい箇所を優先的にカバー

- **網羅観点**  
  - 正常系・異常系  
  - 境界値・バリデーション  
  - 権限・セキュリティ関連  
  - リスクの高い操作フロー

- **自動化推進**  
  - 単体・結合・E2Eの自動テストをCIに組み込み、プルリクエスト時に必ず実行  
  - カバレッジ目標80%以上を目指す  
  - ESLintチェックもCIで必須化し、コード品質を担保

- **レビュー体制**  
  - テスト設計・コードは必ずコードレビューを実施  
  - バグはJIRAまたはGitHub Issuesで管理し、優先度付けを行う  

---

## 4. テスト内容別 使用ツール一覧（フロントエンド／バックエンド区分）

| テスト種別       | 区分         | No | ツール名                   | 用途・役割                                            | 備考・ポイント                                     |
|------------------|--------------|----|----------------------------|------------------------------------------------------|---------------------------------------------------|
| **静的解析**     | フロント     | 1  | ESLint                     | JavaScript/TypeScriptのコード品質チェック            | AirbnbルールやReact向けルールをベースにカスタマイズ。 |
|                  | フロント     | 2  | Prettier                   | コード整形                                           | ESLintと連携しコードの一貫性を保つ。                 |
|                  | バックエンド | 3  | flake8                     | Pythonコード品質チェック                              | PEP8準拠。CIで自動実行。                            |
|                  | バックエンド | 4  | black                      | Pythonコード整形                                      | コードの一貫性を保つ。                              |
| **単体テスト**   | フロント     | 5  | Vitest                     | 関数・コンポーネント単位の動作検証                   | 高速でJest互換API。React Testing Libraryと併用。      |
|                  | フロント     | 6  | React Testing Library      | ユーザー操作（クリック・入力）や画面表示が正しく動作するかをテストコードで検証             | ユーザー視点のUIテストを重視。                      |
|                  | フロント     | 7  | Mock Service Worker (MSW)  | API通信部分をモック化し、外部APIがなくてもフロント単体テストが安定して実行できるように設定   | フロント・バックエンド双方のモックに対応。           |
|                  | バックエンド | 8  | pytest                     | Python関数やAPIエンドポイントごとに、入力・出力・副作用が期待通りかをテストコードで検証     | FastAPIのAPIテストにも利用。                        |
|                  | バックエンド | 9  | Mock                       | DBや外部APIの依存部分をモック化し、バックエンド単体テストが外部環境に依存せず実行できるように設定 | DBやAPIのモックに利用。                             |
| **結合テスト**   | フロント     | 10 | Vitest                     | 複数コンポーネントやAPI連携部分が、実際のデータや状態で正しく連携できるかを検証             | モックやテスト用DB(PostgreSQL)を活用。              |
|                  | フロント     | 11 | Mock Service Worker (MSW)  | APIモックを使い、フロントとバックエンドの連携部分の結合テストを安定して実行できるように設定 | テストの独立性向上に貢献。                           |
|                  | バックエンド | 12 | pytest                     | バックエンドAPIとPostgreSQLテストDBが連携して、データの保存・取得・更新が正しく行われるかを検証 | テスト用DB(PostgreSQL)と組み合わせ                  |
|                  | バックエンド | 13 | ~~SQLite（in-memory）~~    | ~~テスト用軽量DB~~                                   | ~~実DB(PostgreSQL)への影響を避けるため利用。~~       |
|                  | バックエンド | 14 | PostgreSQL（テストDB）     | 本番に近いDB環境で、マイグレーションや複雑なデータ操作の結合テストを実施                     | マイグレーションや本格的なデータ検証に利用。         |
| **E2Eテスト**    | フロント     | 15 | Cypress（検討中）          | 実際のブラウザ上で、ユーザー操作（ログイン・画面遷移など）が期待通りに動作するかを検証       | 本格的なユーザーフロー検証。採用は検討段階。         |
| **CI/CD実行環境**| 共通         | 16 | GitHub Actions             | プルリクエストやマージ時に、静的解析・各種テストが自動で実行されるようCI/CDを設定・運用      | プルリク時にVitest・ESLint・pytest・flake8・blackを自動 |

---

## 5. 用語説明

- **Vitest**  
  VueやReactで使われる高速なテストランナー兼アサーションライブラリ。Jest互換のAPIを持つ。  
- **ESLint**  
  JavaScript/TypeScriptの静的解析ツール。コード品質向上やバグ防止に利用。  
- **E2E（End-to-End）テスト**  
  実際のユーザー操作を模倣し、システム全体の動作を検証するテスト。  
- **Mock/Stub**  
  テスト対象外の外部依存部分を模擬する仕組み。  
- **CI/CD**  
  継続的インテグレーション・継続的デリバリーの略。  

---

## 6. テストケース設計（例）

### 6.1 バックエンドAPI（例：/audio-feedback）

| テストID | 観点           | 事前条件   | 入力・操作               | 期待結果             |
| -------- | -------------- | ---------- | ------------------------ | -------------------- |
| API-01   | 正常系         | サーバ起動 | 有効なwebmファイル送信   | HTTP 200 + テキスト返却 |
| API-02   | 異常系         | サーバ起動 | 未対応拡張子（.aac）送信 | HTTP 400 エラー       |
| API-03   | バリデーション | サーバ起動 | 空ファイル送信           | HTTP 400 エラー       |
| API-04   | 境界値         | サーバ起動 | 最大サイズwebm送信       | HTTP 200 + テキスト返却 |
| API-05   | 権限           | 未認証     | ファイル送信             | HTTP 401/403 エラー   |

### 6.2 フロントエンド（例：ログイン画面）

| テストID | 観点           | 事前条件       | 入力・操作               | 期待結果           |
| -------- | -------------- | -------------- | ------------------------ | ------------------ |
| UI-01    | 正常系         | ユーザー登録済 | 正しいID/PWでログイン    | マイページに遷移   |
| UI-02    | 異常系         | ユーザー登録済 | 誤ったPWでログイン       | エラー表示         |
| UI-03    | バリデーション | なし           | 空欄でログイン           | 入力必須エラー表示 |
| UI-04    | 境界値         | ユーザー登録済 | 最大長ID/PWでログイン    | 正常ログイン       |

### 6.3 DB（例：シーディング・データ整合性）

| テストID | 観点           | 事前条件        | 入力・操作       | 期待結果               |
| -------- | -------------- | --------------- | ---------------- | ---------------------- |
| DB-01    | 正常系         | DB初期化前      | seed.py実行     | ダミーデータ投入完了   |
| DB-02    | 異常系         | usersテーブル空でない | seed.py再実行  | 重複エラーなし         |
| DB-03    | データ整合性   | seed.py実行後   | usersテーブル参照 | 必須カラムが全て埋まる |

---

## 7. テストコード方針

- **正常系・異常系の両方を実装**  
- **ステートレステスト**  
  - 単一API呼び出しの結果検証  
- **ステートフルテスト**  
  - 連続したAPI呼び出しや画面遷移を含むシナリオテスト  
- **依存性管理**  
  - Mock/Stubの利用徹底でテストの独立性を確保  
  - テスト用DBの活用で実DBの状態を汚さない  
- **テストコード管理**  
  - `tests/`ディレクトリ配下に分類し、命名規則を統一  
  - コードレビュー必須  

---

## 8. カバレッジ管理

- **基準**  
  - ステートメント/分岐カバレッジ80%以上を目標  
- **測定**  
  - **Vitest** のカバレッジ機能を用いて定期的に測定  
  - GitHub ActionsなどCIで自動測定を実施  
- **改善**  
  - 未カバー領域を抽出し、優先的にテスト追加  
  - 改善活動はJIRAやGitHub Issuesで管理  

---

## 9. 静的解析（ESLint）

- **目的**  
  コードの品質維持とバグの早期発見のため、ESLintを導入。  

- **ルールセット**  
  - Airbnbや公式Reactルールをベースにプロジェクトに適したカスタマイズを適用  
  - Prettierと連携し、コード整形ルールを統一  

- **CI連携**  
  - プルリクエスト時にESLintを自動実行し、エラー・警告を検出  
  - 基本的に警告も修正対象とする運用  

---

## 10. テストデータ例

### 10.1 ユーザーデータ例（Userモデル）

| id                                   | firebase_uid            | name      | age  | icon_image                       | created_at               |
|-------------------------------------|-------------------------|-----------|------|---------------------------------|--------------------------|
| `123e4567-e89b-12d3-a456-426614174000` | `firebase_uid_user1`    | Hanako    | 10   | `https://example.com/icon1.png` | 2025-07-01T09:00:00Z     |
| `223e4567-e89b-12d3-a456-426614174001` | `firebase_uid_user2`    | Taro      | 12   | `https://example.com/icon2.png` | 2025-07-02T10:30:00Z     |

---

### 10.2 フィードバック・スコア記録データ例（Feedback, ScoreRecordモデル）

| id  | user_id                               | presentation_id | total_score | well_done                 | next_challenge            | created_at               |
|------|-------------------------------------|-----------------|-------------|---------------------------|---------------------------|--------------------------|
| 1    | `123e4567-e89b-12d3-a456-426614174000` | 101             | 85          | "明瞭に話せました"        | "イントネーションを改善"   | 2025-07-10T15:00:00Z     |
| 2    | `223e4567-e89b-12d3-a456-426614174001` | 102             | 78          | "滑らかな話し方でした"    | "語彙を増やしましょう"     | 2025-07-11T16:30:00Z     |

---

### 10.3 ScoreRecordの例データ

| feedback_id | presentation_id | transcript                     | audio_url                          | presentation_created_at | total_score | well_done                 | next_challenge            | feedback_created_at       |
|-------------|-----------------|-------------------------------|----------------------------------|------------------------|-------------|---------------------------|---------------------------|--------------------------|
| 1           | 101             | "今日は晴れです。プレゼン開始" | `https://example.com/audio1.webm` | 2025-07-10T14:50:00Z   | 85          | "明瞭に話せました"        | "イントネーションを改善"   | 2025-07-10T15:00:00Z     |
| 2           | 102             | "私の好きな食べ物は…"            | `https://example.com/audio2.webm` | 2025-07-11T16:00:00Z   | 78          | "滑らかな話し方でした"    | "語彙を増やしましょう"     | 2025-07-11T16:30:00Z     |

---

### 10.4 音声ファイル（アップロード用）

| ファイル名          | ファイル形式 | サイズ (MB) | 説明                     | 用途          |
|---------------------|--------------|-------------|--------------------------|---------------|
| sample_valid_1.webm  | webm         | 2.5         | 正常系サンプル音声       | 正常系テスト  |
| sample_valid_2.m4a   | m4a          | 3.1         | 正常系サンプル音声       | 正常系テスト  |
| sample_empty.webm    | webm         | 0           | 空ファイル               | バリデーション|
| sample_unsupported.aac | aac          | 1.0         | 未対応フォーマット       | 異常系テスト  |
| sample_large.webm    | webm         | 10          | 最大許容サイズ           | 境界値テスト  |

---

## 11. バグ対応フロー（概要）

1. テストや運用でバグを検出  
2. GitHub Issues/JIRAに登録し、再現手順・影響範囲を記載  
3. 優先度を決定し、担当者へ割り当て  
4. 修正・レビュー・テスト再実施  
5. クローズ・報告  

---
## 12. 作業チェックリスト（テスト種別ごと・実施状況付き／詳細版）

### 1. 静的解析
| ステップ | 区分      | ツール名   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 1.1 ✅  | frontend  | ESLint     | プロジェクト全体のJS/TSコードに対して、構文・品質・ルール違反を自動検出できるよう設定・運用 | `.eslintrc.js`, `.eslintignore`            |
| 1.2 ✅  | frontend  | Prettier   | コードの書式（インデント・改行・スペース等）が統一されるように設定し、CIでも自動整形         | `.prettierrc`, `.prettierignore`           |
| 1.3 ✅  | backend   | flake8     | PythonコードのPEP8準拠や品質違反を自動検出できるよう設定・運用                             | `.flake8`                                  |
| 1.4 ✅  | backend   | black      | Pythonコードの書式（インデント・スペース等）が統一されるように設定し、CIでも自動整形         | `pyproject.toml`                           |

### 2. 単体テスト
| ステップ | 区分      | ツール名                   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|----------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 2.1 ✅  | frontend  | Vitest                     | Reactコンポーネントや関数ごとに、入力・出力・副作用が期待通りかをテストコードで検証         | `frontend/tests/`                          |
| 2.2 ✅  | frontend  | React Testing Library      | ユーザー操作（クリック・入力）や画面表示が正しく動作するかをテストコードで検証             | `frontend/tests/`                          |
| 2.3 ✅  | frontend  | Mock Service Worker (MSW)  | API通信部分をモック化し、外部APIがなくてもフロント単体テストが安定して実行できるように設定   | MSW関連ファイル                             |
| 2.4 ✅  | backend   | pytest                     | Python関数やAPIエンドポイントごとに、入力・出力・副作用が期待通りかをテストコードで検証     | `backend/tests/`                           |
| 2.5 ✅  | backend   | Mock                       | DBや外部APIの依存部分をモック化し、バックエンド単体テストが外部環境に依存せず実行できるように設定 | `backend/tests/mocks/`                     |

### 3. 結合テスト
| ステップ | 区分      | ツール名                   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|----------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 3.1     | frontend  | Vitest                     | 複数コンポーネントやAPI連携部分が、実際のデータや状態で正しく連携できるかを検証             | `frontend/tests/`                          |
| 3.2     | frontend  | Mock Service Worker (MSW)  | APIモックを使い、フロントとバックエンドの連携部分の結合テストを安定して実行できるように設定 | MSW関連ファイル                             |
| 3.3     | backend   | pytest                     | バックエンドAPIとPostgreSQLテストDBが連携して、データの保存・取得・更新が正しく行われるかを検証 | `backend/tests/`, マイグレーション関連      |
| 3.4     | backend   | PostgreSQL（テストDB）     | 本番に近いDB環境で、マイグレーションや複雑なデータ操作の結合テストを実施                     | `backend/tests/`, マイグレーション関連      |


### 4. E2Eテスト
| ステップ | 区分      | ツール名                   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|----------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 4.1     | frontend  | Cypress（検討中）          | 実際のブラウザ上で、ユーザー操作（ログイン・画面遷移など）が期待通りに動作するかを検証       | `cypress/`                                 |
| 4.2     | frontend  | Cypress（検討中）          | 主要なユーザーフロー（例：ログイン→投稿→一覧表示など）のE2Eテストシナリオを作成・実装       | テストシナリオファイル                      |

### 5. CI/CD実行環境
| ステップ | 区分      | ツール名                   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|----------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 5.1 ✅  | 共通      | GitHub Actions             | プルリクエストやマージ時に、静的解析・各種テストが自動で実行されるようCI/CDを設定・運用      | `.github/workflows/ci.yml`                 |

### 6. その他・報告
| ステップ | 区分      | ツール名                   | チェック内容（目的・作業）                                                                 | 備考（修正・追加ファイル等）                |
|---------|-----------|----------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------|
| 6.1     | 共通      | -                          | テスト結果・課題・改善点をテスト報告書にまとめ、関係者へ共有                              | テスト報告書ファイル                        |
| 6.2     | 共通      | -                          | 関係者からフィードバックを取得し、必要に応じて改善対応                                    | -                                          |
| 6.3     | 共通      | -                          | 次の開発フェーズやリリースに向けて準備                                                    | -                                          |

---